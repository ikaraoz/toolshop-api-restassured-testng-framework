name: API Test Pipeline

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options: [local, qa, staging]
      groups:
        description: "TestNG group to run"
        required: true
        default: "all"
        type: choice
        options: [all, smoke, regression]
  schedule:
    - cron: "0 2 * * *" # run daily at 2 AM UTC
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      ALLURE_RESULTS: build/allure-results
      ALLURE_REPORT: build/reports/allure-report/allureReport

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: âš™ï¸ Make Gradle executable
        run: chmod +x gradlew

      - name: ğŸš€ Run API tests
        run: |
          echo "Running tests for environment: ${{ inputs.env }}"
          GROUP_ARG=""
          if [ "${{ inputs.groups }}" != "all" ]; then
            GROUP_ARG="-Dgroups=${{ inputs.groups }}"
          fi
          ./gradlew clean test $GROUP_ARG -Denv=${{ inputs.env }}

      - name: ğŸ§¾ Generate Allure report
        run: ./gradlew allureReport --info

      - name: ğŸ•’ Prepare historical folder
        id: report_info
        run: |
          DATE_DIR=$(date -u +"%Y-%m-%d_%H-%M-%S")
          DEST_DIR="history/${DATE_DIR}_${{ inputs.env }}"
          mkdir -p "build/history/${DEST_DIR}"
          echo "âœ… Copying Allure report to build/history/${DEST_DIR}/"
          if [ -d "build/reports/allure-report" ]; then
            cp -r build/reports/allure-report/* "build/history/${DEST_DIR}/"
          elif [ -d "build/reports/allureReport" ]; then
            cp -r build/reports/allureReport/* "build/history/${DEST_DIR}/"
          else
            echo "âŒ ERROR: Allure report directory not found!"
            exit 1
          fi
          echo "dest_dir=$DEST_DIR" >> $GITHUB_OUTPUT
          echo "ğŸ“‚ Contents of destination:"
          ls -R "build/history/${DEST_DIR}"

      - name: ğŸ§¼ Keep only the latest 10 reports
        run: |
          mkdir -p build/history
          ls -dt build/history/*/ | tail -n +11 | xargs -r rm -rf
          echo "âœ… Old reports cleaned"
          ls -dt build/history/*/ || echo "No history yet"

      - name: ğŸ§­ Generate index.html for GitHub Pages
        run: |
          mkdir -p build/history
          INDEX_FILE=build/history/index.html
          echo "<html><head><title>Allure Report History</title></head><body>" > $INDEX_FILE
          echo "<h1>Allure Report History</h1><ul>" >> $INDEX_FILE
          for d in $(ls -dt build/history/*/ | head -n 10); do
            folder=$(basename "$d")
            echo "<li><a href=\"history/${folder}/\">${folder}</a></li>" >> $INDEX_FILE
          done
          echo "</ul></body></html>" >> $INDEX_FILE
          echo "âœ… index.html generated at build/history/index.html"

      - name: ğŸŒ Publish Allure reports + index to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: build/history
          force_orphan: true
          commit_message: "ğŸ§¾ Publish Allure report with history for ${{ inputs.env }}"

      - name: ğŸ’¾ Upload latest Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.env }}-${{ inputs.groups }}
          path: build/reports/allure-report/allureReport
