name: API Test Pipeline

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options: [local, qa, staging]
      groups:
        description: "TestNG group to run"
        required: true
        default: "all"
        type: choice
        options: [all, smoke, regression]
  schedule:
    - cron: "0 2 * * *" # run daily at 2 AM UTC
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      REPORT_PATH: build/reports/allure-report/allureReport

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: âš™ï¸ Make Gradle executable
        run: chmod +x gradlew

      - name: ğŸš€ Run API tests
        run: |
          echo "Running tests for environment: ${{ inputs.env }}"
          GROUP_ARG=""
          if [ "${{ inputs.groups }}" != "all" ]; then
            GROUP_ARG="-Dgroups=${{ inputs.groups }}"
          fi
          ./gradlew clean test $GROUP_ARG -Denv=${{ inputs.env }}

      - name: ğŸ§¾ Generate Allure report
        run: ./gradlew allureReport --info

      - name: ğŸ“‚ Verify Allure report exists
        run: |
          echo "Verifying generated Allure report at ${{ env.REPORT_PATH }}"
          ls -R ${{ env.REPORT_PATH }} || (echo "âŒ Allure report missing!" && exit 1)

      - name: ğŸŒ Publish Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ env.REPORT_PATH }}
          force_orphan: true
          commit_message: "ğŸ§¾ Publish Allure report for ${{ inputs.env }} - ${{ inputs.groups }}"

      - name: ğŸ”— Log published report URL
        run: |
          echo "âœ… Allure report published successfully!"
          echo "ğŸŒ URL: https://ikaraoz.github.io/toolshop-api-restassured-testng-framework/"
