name: API Test Pipeline

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options: [local, qa, staging]
      groups:
        description: "TestNG group to run"
        required: true
        default: "all"
        type: choice
        options: [all, smoke, regression]
  schedule:
    - cron: "0 2 * * *" # run daily at 2 AM UTC
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      REPORT_PATH: build/reports/allure-report/allureReport

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: âš™ï¸ Make Gradle executable
        run: chmod +x gradlew

      - name: ğŸš€ Run API tests
        run: |
          echo "Running tests for environment: ${{ inputs.env }}"
          GROUP_ARG=""
          if [ "${{ inputs.groups }}" != "all" ]; then
            GROUP_ARG="-Dgroups=${{ inputs.groups }}"
          fi
          ./gradlew clean test $GROUP_ARG -Denv=${{ inputs.env }}

      - name: ğŸ§¾ Generate Allure report
        run: ./gradlew allureReport --info

      - name: ğŸ” Verify Allure report path exists
        id: verify_report
        run: |
          echo "Checking for Allure report at: $REPORT_PATH"
          if [ ! -d "$REPORT_PATH" ]; then
            echo "âŒ ERROR: $REPORT_PATH not found!"
            echo "Listing contents of build/reports:"
            ls -R build/reports || true
            exit 1
          fi
          echo "âœ… Found report at $REPORT_PATH"
          echo "report_dir=$REPORT_PATH" >> $GITHUB_OUTPUT
          ls -la "$REPORT_PATH"

      - name: ğŸ•’ Prepare history folder
        id: report_info
        run: |
          DATE_DIR=$(date -u +"%Y-%m-%d_%H-%M-%S")
          DEST_DIR="history/${DATE_DIR}_${{ inputs.env }}"
          mkdir -p "build/history/${DEST_DIR}"
          cp -r "${{ env.REPORT_PATH }}"/* "build/history/${DEST_DIR}/"
          echo "dest_dir=$DEST_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Copied report to build/history/${DEST_DIR}"

      - name: ğŸ§¼ Keep only last 10 reports
        run: |
          mkdir -p build/history
          ls -dt build/history/*/ | tail -n +11 | xargs -r rm -rf
          echo "âœ… Cleaned old reports"

      - name: ğŸ§­ Generate index.html
        run: |
          mkdir -p build/history
          INDEX_FILE=build/history/index.html
          echo "<html><head><title>Allure Report History</title></head><body>" > $INDEX_FILE
          echo "<h1>Allure Report History</h1><ul>" >> $INDEX_FILE
          for d in $(ls -dt build/history/*/ | head -n 10); do
            folder=$(basename "$d")
            echo "<li><a href=\"${folder}/index.html\">${folder}</a></li>" >> $INDEX_FILE
          done
          echo "</ul></body></html>" >> $INDEX_FILE
          echo "âœ… index.html generated"

      - name: ğŸŒ Publish Allure reports + index to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: build/history
          force_orphan: true
          commit_message: "ğŸ§¾ Publish Allure report for ${{ inputs.env }} - ${{ inputs.groups }}"

      - name: ğŸ’¾ Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.env }}-${{ inputs.groups }}
          path: ${{ env.REPORT_PATH }}
