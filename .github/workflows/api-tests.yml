name: API Test Pipeline

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options: [local, qa, staging]
      groups:
        description: "TestNG group to run"
        required: true
        default: "all"
        type: choice
        options: [all, smoke, regression]
  schedule:
    - cron: "0 2 * * *" # run daily at 2 AM UTC
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      REPORT_PATH: build/reports/allure-report/allureReport

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"

      - name: âš™ï¸ Make Gradle executable
        run: chmod +x gradlew

      - name: ğŸš€ Run API tests
        id: run_tests
        run: |
          ENV_NAME="${{ inputs.env || 'qa' }}"
          GROUP_NAME="${{ inputs.groups || 'all' }}"
          echo "Running tests for environment: $ENV_NAME"
          echo "Selected group(s): $GROUP_NAME"

          GROUP_ARG=""
          if [ "$GROUP_NAME" != "all" ]; then
            GROUP_ARG="-Dgroups=$GROUP_NAME"
          fi

          # Run tests and capture exit code
          set +e
          ./gradlew clean test $GROUP_ARG -Denv=$ENV_NAME
          TEST_RESULT=$?
          echo "test_result=$TEST_RESULT" >> $GITHUB_OUTPUT
          set -e

      - name: ğŸ§¾ Generate Allure report
        if: always()
        run: ./gradlew allureReport --info

      - name: ğŸ“‚ Verify Allure report exists
        if: always()
        run: |
          echo "Verifying generated Allure report at ${{ env.REPORT_PATH }}"
          ls -R ${{ env.REPORT_PATH }} || (echo "âŒ Allure report missing!" && exit 1)

      - name: ğŸŒ Publish Allure report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ env.REPORT_PATH }}
          force_orphan: true
          commit_message: "ğŸ§¾ Publish Allure report for ${{ inputs.env || 'qa' }} - ${{ inputs.groups || 'all' }}"

      - name: ğŸ’¾ Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.env || 'qa' }}-${{ inputs.groups || 'all' }}
          path: ${{ env.REPORT_PATH }}
          retention-days: 7  # keep for a week

      - name: ğŸš¨ Mark build as failed if tests failed
        if: always()
        run: |
          if [ "${{ steps.run_tests.outputs.test_result }}" != "0" ]; then
            echo "âŒ Some tests failed. Marking workflow as failed."
            exit 1
          else
            echo "âœ… All tests passed successfully."
          fi

      - name: ğŸ”— Log published report URL
        if: always()
        run: |
          echo "âœ… Allure report published successfully!"
          echo "ğŸŒ Access it here:"
          echo "   https://ikaraoz.github.io/toolshop-api-restassured-testng-framework/"
