name: API Test Pipeline

on:
  workflow_dispatch:
    inputs:
      env:
        description: "Target environment"
        required: true
        default: "qa"
        type: choice
        options: [local, qa, staging]
      groups:
        description: "TestNG group to run"
        required: true
        default: "all"
        type: choice
        options: [all, smoke, regression]
  schedule:
    - cron: "0 2 * * *" # every day at 2 AM UTC
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      ALLURE_RESULTS: build/allure-results
      ALLURE_REPORT: build/reports/allure-report/allureReport

    permissions:
      contents: write   # âœ… required for GitHub Pages publishing
      actions: read

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: â˜• Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: âš™ï¸ Set executable permission for Gradle
        run: chmod +x gradlew

      - name: ğŸš€ Run API tests
        run: |
          echo "Running tests for environment: ${{ inputs.env }}"
          GROUP_ARG=""
          if [ "${{ inputs.groups }}" != "all" ]; then
            GROUP_ARG="-Dgroups=${{ inputs.groups }}"
          fi
          ./gradlew clean test $GROUP_ARG -Denv=${{ inputs.env }}

      - name: ğŸ§¾ Generate Allure report
        run: ./gradlew allureReport --info

      - name: ğŸ“‚ Verify Allure output
        run: |
          echo "Listing generated Allure files..."
          ls -R build/reports/allure-report || true
          ls -R build/allure-results || true
      - name: ğŸ§¹ Disable caching for GitHub Pages
        run: |
          # Create a .nojekyll file so GitHub Pages serves files directly
          echo "" > build/reports/allure-report/allureReport/.nojekyll
          # Add cache-control headers (for GitHub CDN)
          echo "Cache-Control: no-cache, no-store, must-revalidate" > build/reports/allure-report/allureReport/.htaccess
          # Optional: timestamp file to confirm freshness
          date > build/reports/allure-report/allureReport/build-time.txt

      - name: ğŸŒ Publish Allure report to GitHub Pages
        if: always() # âœ… even if tests fail
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: build/reports/allure-report/allureReport
          force_orphan: true
          commit_message: "ğŸ§¾ Publish Allure report from workflow run"
          cname: ""

      - name: ğŸ’¾ Upload Allure report as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report-${{ inputs.env }}-${{ inputs.groups }}
          path: build/reports/allure-report/allureReport
